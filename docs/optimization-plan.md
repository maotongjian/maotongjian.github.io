# ttmall_next 性能优化方案

## 一、网络请求优化

### 1. 根组件 `_app.jsx` 服务器端发起 13 个并发请求

#### 预期目标：

- 降低人均访问服务器负载压力；
- 提高服务器响应速度；
- 减小服务端生成 HTML 大小，提高页面文档资源加载速度。

#### 实施方案：

- 合并每个页面都需要用到的数据接口，如页头页脚等模块；
- 根据路由请求需要用到的数据，当前页面未使用的不发起请求；
- 核对这些接口是否都使用了服务器端缓存策略。

### 2. 网站接口请求

#### 预期目标：

- 提升判断网站的灵活性；
- 在逻辑判断时，无需等待网站接口数据请求成功后进行；
- 在未使用除网站简称外数据时，无需发起网站接口请求；
- 减小服务端生成 HTML 大小，提高页面文档资源加载速度；
- 即使接口网站简称更改，也不会影响到前端代码逻辑判断；
- 在判断网站的逻辑如 `useEffect` 或 `useMemo` 等，取消依赖 `websiteInfo` 或 `websiteInfo.website_short_name`，避免额外的性能损耗、避免额外的 `setState` 更新。

#### 实施方案：

- 已在 Node 环境下的 `process.env` 环境变量添加对应网站简称，可通过 `process.env.WEBSITE_NAME` 访问；
- 统一项目中所有依赖 `websiteInfo.website_short_name` 判断网站的地方为这种方式；
- 取消测试环境根据网站简称切换网站功能；
- 增加一个可以随时修改构建时启动命令的 Jenkins，用以动态构建测试环境除 GG 外其他功能的测试。

### 3. 客户端交互请求

#### 预期目标：

- 在完成一次交互，进入下一步之前理想情况下最多发起一个请求，总时间在 1-2 秒内；
- 统计整个项目内所有交互到下一步之前花费的请求时间并进行优化。

#### 实施方案：

- 以打开快速商品详情下单弹框为例：
  ![图片](/plan-1.png 'plan-1')
  - 在点击按钮 => 等待 => 弹框显示的过程中，一共发起了 4 个请求，分别是商品详情、优惠、用户信息、秒杀；
  - 由于这里并发了商品详情和优惠两个接口，两个接口请求完成后打开商品详情弹框，打开商品详情弹框后发起剩余两个请求，那么这里的等待时间就是请求商品详情所花费的时间 1.1 秒；
    ![图片](/plan-2.png 'plan-2')
  - 可以看到在这个示例中前端已经很好地处理了多个请求的时机；
  - 进一步检查剩余两个接口数据的用途，如果用于在弹框内渲染节点展示给用户，为避免 CLS 可使用骨架屏进行占位；如果不想使用骨架屏可以放在打开弹框之前一起并发，前提是这个接口请求的时间要小于商品详情的时间，否则将延后弹框的显示时间；
  - 是否可以进一步优化：后端是否支持合并这两个接口，减少 HTTP 请求次数，减少网络延迟，降低带宽消耗。

## 二、DOM 渲染优化

### 1. 渲染卡顿

#### 预期目标：

- 降低页面渲染压力，通过避免不必要的渲染，减少浏览器渲染的压力；
- 提高渲染效率，在渲染逻辑中减少计算和对象重建；
- 通过 4 倍乃至 20 倍 CPU 降速适配低端设备的渲染能力。

#### 实施方案：

- 所有子组件使用 `React.memo` 包裹；
- 所有传递给子组件的函数在定义的过程中都使用 `React.useCallback` 包裹，所有函数体很复杂的函数在定义的过程中都使用 `React.useCallback` 包裹，所有渲染类函数在定义的过程中都使用 `React.useCallback` 包裹；
- 不需要在每次渲染时重新计算的函数重建使用 `useMemo` 包裹。

### 2. 渲染时机

#### 预期目标：

- 减少用户白屏等待时间。

#### 实施方案：

- 用于在加载过程中渲染页面的数据来源，如果在客户端的放到服务器端请求。

### 3. 渲染方式

#### 预期目标：

- SSR 和 SSG 同时部署。

#### 实施方案：

- 对于内容较为固定的页面使用 SSG 在构建的过程中预渲染的方式，将生成的静态 HTML 部署到 CDN。

## 三、依赖包管理优化

#### 预期目标：

- 使用体积较小的包。

#### 实施方案：

- 去除 `moment.js`，相关逻辑依赖 `day.js` 重写。

## 四、Page 路由升级 App 路由

#### 预期目标：

- 提升渲染性能；
- 提升布局的灵活性；
- 错误页面布局支持动态交互。

## 五、Next.js 版本升级

### **Next@13 升级 Next@15**

#### 预期目标：

- 提升构建和热更新速度；
- 提升生产环境的稳定性与性能。
